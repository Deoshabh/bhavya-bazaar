<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhavya Bazaar - WebSocket & API Diagnostics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .header h1 {
            color: #667eea;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-section h3 .status {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: normal;
        }
        .status.pending { background: #ffc107; color: #856404; }
        .status.running { background: #17a2b8; color: white; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-line {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-line.success { color: #28a745; }
        .log-line.error { color: #dc3545; }
        .log-line.warning { color: #ffc107; }
        .log-line.info { color: #17a2b8; }
        
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .config-item {
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .summary {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
        }
        
        .summary.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .auto-refresh {
            text-align: center;
            margin: 20px 0;
        }
        
        .refresh-countdown {
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ WebSocket & API Diagnostics</h1>
            <p>Real-time testing for Bhavya Bazaar backend connectivity</p>
        </div>

        <div class="test-section">
            <h3>üè• Backend Health Check <span class="status pending" id="health-status">Pending</span></h3>
            <p>Testing if the backend API is responding</p>
            <button class="test-button" onclick="testBackendHealth()">Test Backend Health</button>
            <div class="results" id="health-results"></div>
        </div>

        <div class="test-section">
            <h3>üîå WebSocket Connection <span class="status pending" id="websocket-status">Pending</span></h3>
            <p>Testing Socket.IO connection to backend</p>
            <button class="test-button" onclick="testWebSocketConnection()">Test WebSocket</button>
            <button class="test-button" onclick="disconnectWebSocket()">Disconnect</button>
            <div class="results" id="websocket-results"></div>
        </div>

        <div class="test-section">
            <h3>üåê API Endpoints <span class="status pending" id="api-status">Pending</span></h3>
            <p>Testing various API endpoints</p>
            <button class="test-button" onclick="testApiEndpoints()">Test API Endpoints</button>
            <div class="results" id="api-results"></div>
        </div>

        <div class="config-section">
            <h3>‚öôÔ∏è Current Configuration</h3>
            <div class="config-item">Backend URL: <span id="config-backend"></span></div>
            <div class="config-item">WebSocket URL: <span id="config-websocket"></span></div>
            <div class="config-item">Current Domain: <span id="config-domain"></span></div>
            <div class="config-item">Environment: <span id="config-env"></span></div>
        </div>

        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()"> 
                Auto-refresh tests every <span class="refresh-countdown" id="countdown">30</span> seconds
            </label>
        </div>

        <div class="summary" id="summary">
            <h3>üîÑ Run tests to see overall status</h3>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let autoRefreshInterval = null;
        let countdownInterval = null;
        let countdownValue = 30;

        // Configuration
        const CONFIG = {
            backend: 'https://api.bhavyabazaar.com',
            websocket: 'wss://api.bhavyabazaar.com/socket.io',
            domain: window.location.hostname,
            env: window.location.hostname === 'localhost' ? 'development' : 'production'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateConfigDisplay();
            runAllTests();
        });

        function updateConfigDisplay() {
            document.getElementById('config-backend').textContent = CONFIG.backend;
            document.getElementById('config-websocket').textContent = CONFIG.websocket;
            document.getElementById('config-domain').textContent = CONFIG.domain;
            document.getElementById('config-env').textContent = CONFIG.env;
        }

        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = text || status.toUpperCase();
        }

        async function testBackendHealth() {
            updateStatus('health-status', 'running', 'Testing...');
            clearResults('health-results');
            
            try {
                logResult('health-results', 'Testing backend health endpoint...', 'info');
                
                const response = await fetch(`${CONFIG.backend}/api/v2/health`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    logResult('health-results', `‚úÖ Backend is healthy!`, 'success');
                    logResult('health-results', `Status: ${data.status}`, 'success');
                    logResult('health-results', `Service: ${data.service}`, 'info');
                    logResult('health-results', `Response time: ${response.headers.get('x-response-time') || 'N/A'}`, 'info');
                    updateStatus('health-status', 'success', 'Healthy');
                    return true;
                } else {
                    logResult('health-results', `‚ùå Backend returned ${response.status} ${response.statusText}`, 'error');
                    updateStatus('health-status', 'error', `Error ${response.status}`);
                    return false;
                }
            } catch (error) {
                logResult('health-results', `‚ùå Backend connection failed: ${error.message}`, 'error');
                logResult('health-results', `üí° Check if backend service is running in Coolify`, 'warning');
                updateStatus('health-status', 'error', 'Failed');
                return false;
            }
        }

        function testWebSocketConnection() {
            updateStatus('websocket-status', 'running', 'Connecting...');
            clearResults('websocket-results');
            
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            try {
                logResult('websocket-results', 'Attempting WebSocket connection...', 'info');
                logResult('websocket-results', `URL: ${CONFIG.websocket}`, 'info');

                socket = io(CONFIG.websocket, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    reconnection: true,
                    reconnectionAttempts: 3,
                    reconnectionDelay: 1000
                });

                socket.on('connect', () => {
                    logResult('websocket-results', `‚úÖ WebSocket connected successfully!`, 'success');
                    logResult('websocket-results', `Socket ID: ${socket.id}`, 'info');
                    logResult('websocket-results', `Transport: ${socket.io.engine.transport.name}`, 'info');
                    updateStatus('websocket-status', 'success', 'Connected');
                    
                    // Test message sending
                    socket.emit('test-message', { 
                        message: 'Diagnostic test', 
                        timestamp: new Date().toISOString() 
                    });
                    logResult('websocket-results', 'üì§ Test message sent', 'info');
                });

                socket.on('connect_error', (error) => {
                    logResult('websocket-results', `‚ùå Connection failed: ${error.message}`, 'error');
                    logResult('websocket-results', `üí° Verify backend health and CORS settings`, 'warning');
                    updateStatus('websocket-status', 'error', 'Failed');
                });

                socket.on('disconnect', (reason) => {
                    logResult('websocket-results', `üîå Disconnected: ${reason}`, 'warning');
                    updateStatus('websocket-status', 'pending', 'Disconnected');
                });

                socket.on('error', (error) => {
                    logResult('websocket-results', `üö® Socket error: ${error}`, 'error');
                });

                // Test timeout
                setTimeout(() => {
                    if (socket && !socket.connected) {
                        logResult('websocket-results', '‚è∞ Connection timeout', 'error');
                        updateStatus('websocket-status', 'error', 'Timeout');
                    }
                }, 10000);

            } catch (error) {
                logResult('websocket-results', `‚ùå Socket setup failed: ${error.message}`, 'error');
                updateStatus('websocket-status', 'error', 'Failed');
            }
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                logResult('websocket-results', 'üîå WebSocket disconnected manually', 'info');
                updateStatus('websocket-status', 'pending', 'Disconnected');
            }
        }

        async function testApiEndpoints() {
            updateStatus('api-status', 'running', 'Testing...');
            clearResults('api-results');
            
            const endpoints = [
                { url: '/api/v2/health', name: 'Health Check' },
                { url: '/api/v2/product/get-all-products', name: 'Products' },
                { url: '/socket/status', name: 'Socket Status' }
            ];

            let successCount = 0;
            
            for (const endpoint of endpoints) {
                try {
                    logResult('api-results', `Testing ${endpoint.name}...`, 'info');
                    
                    const response = await fetch(`${CONFIG.backend}${endpoint.url}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        logResult('api-results', `‚úÖ ${endpoint.name}: ${response.status} OK`, 'success');
                        successCount++;
                    } else {
                        logResult('api-results', `‚ùå ${endpoint.name}: ${response.status} ${response.statusText}`, 'error');
                    }
                } catch (error) {
                    logResult('api-results', `‚ùå ${endpoint.name}: ${error.message}`, 'error');
                }
            }

            if (successCount === endpoints.length) {
                updateStatus('api-status', 'success', 'All OK');
            } else if (successCount > 0) {
                updateStatus('api-status', 'warning', `${successCount}/${endpoints.length} OK`);
            } else {
                updateStatus('api-status', 'error', 'All Failed');
            }
        }

        async function runAllTests() {
            const healthOk = await testBackendHealth();
            
            if (healthOk) {
                testWebSocketConnection();
                setTimeout(() => testApiEndpoints(), 2000);
                updateSummary('success', '‚úÖ All systems operational!');
            } else {
                updateSummary('error', '‚ùå Backend is down - fix backend service in Coolify first');
            }
        }

        function updateSummary(type, message) {
            const summary = document.getElementById('summary');
            summary.className = `summary ${type}`;
            summary.innerHTML = `<h3>${message}</h3>`;
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');
            
            if (checkbox.checked) {
                countdownValue = 30;
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing intervals
            
            countdownInterval = setInterval(() => {
                countdownValue--;
                document.getElementById('countdown').textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    countdownValue = 30;
                    runAllTests();
                }
            }, 1000);
        }

        function stopAutoRefresh() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            countdownValue = 30;
            document.getElementById('countdown').textContent = countdownValue;
        }

        // Add global functions for console access
        window.testBackendHealth = testBackendHealth;
        window.testWebSocketConnection = testWebSocketConnection;
        window.testApiEndpoints = testApiEndpoints;
        window.runAllTests = runAllTests;
        
        console.log('üí° Diagnostic tools loaded! You can also run:');
        console.log('  - testBackendHealth()');
        console.log('  - testWebSocketConnection()');
        console.log('  - testApiEndpoints()');
        console.log('  - runAllTests()');
    </script>
</body>
</html>
